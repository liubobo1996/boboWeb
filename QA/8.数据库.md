# 目录
- 事务
    - 定义
    - 性质
    - 并发事务的 4 个问题
    - 事务隔离级别
- MySQL 锁
    - 表级锁 行级锁
    - 共享锁 排他锁
- MySQL 性能优化
- 索引
    - 作用
    - 底层数据结构
    - 类型

### 事务
```bash
# 定义
保证对数据库的多个操作构成一个逻辑上的整体, 这些操作要么都执行要么都不执行

# 性质 (AID 是手段, C 是目的)
# 原子性 Atomicity
事务是最小的执行单位, 事务的一组操作要么都执行要么都不执行
# 一致性 Consistency
数据在事务执行前后保持一致 # 转账前后双方总额一致
# 隔离性 Isolation
并发访问数据库时, 一个用户的事务不会被其他事务所干扰, 各事务对数据库的影响是独立的
# 持久性 Durability
事务提交之后, 它对数据库中数据的改变是持久的, 即使数据库发生故障也不会影响这种改变

# 并发事务的 4 个问题 (原始数据为[t0 c0])
# 脏读 (改到一半读)
1. [t1 c0] # 用户一修改标题            
2. [t1 c0] # 用户二读新标题旧内容       
3. [t1 c1] # 用户一修改内容            
# 脏写/丢失修改 (改到一半改)
1. [t1 c0] # 用户一修改标题
2. [t2 c0] # 用户二修改标题
3. [t2 c2] # 用户二修改内容
4. [t2 c1] # 用户一修改内容
# 不可重复读 (读到一半改)
1. [t0 c0] # 用户一读数据   
2. [t2 c2] # 用户二改数据   
3. [t2 c2] # 用户一读数据   
# 幻读 (读到一半增删)
1. [1 t0 c0]            # 用户一读数据   
2. [1 t0 c0] [2 t0 c0]  # 用户二插数据   
3. [1 t0 c0] [2 t0 c0]  # 用户一读数据   

# 事务隔离级别 (MySQL 默认级别为可重复读, 通过加锁和 MVCC 机制解决幻读)
            脏读  不可重复读 幻读
读取未提交    ✔       ✔      ✔
读取已提交    ✖       ✔      ✔
可重复读      ✖       ✖      ✔
串行化        ✖       ✖      ✖
```

### MySQL 锁
```bash
# 表级锁和行级锁
1. 表级锁对当前操作的整张表加锁, 行级锁对当前操作的行加锁
2. 表级锁开销小, 不会死锁, 加锁粒度最大, 冲突概率提高, 并发度降低. 行级锁反之

# 共享锁, Share Lock, S 锁
事务在读数据时获取, 锁兼容
# 排他锁, Exclusive Lock, X 锁
事务在写数据时获取, 锁不兼容
```

### MySQL 性能优化
```bash
# 用 explain 查看 sql 怎么执行
# 优化思路
1. 命中索引
2. 减少查询时遍历的数据
3. 减少返回的数据, 只返回必要的列
# 开启 mysql 缓存机制
```

### 索引
##### 1. 作用
```bash
# 作用
1. 提高数据查询速度, 减少查询涉及的数据量
2. 唯一索引可以保证每行数据的唯一性
```
##### 2. 底层数据结构 [(InnoDB 的一棵 B+ 树可以存放多少行数据?)](https://zhuanlan.zhihu.com/p/81273236)
哈希表 (适用于等值查询, 不支持范围查询和模糊查询等)

![Hash Index](https://github.com/liubobo1996/boboWeb/raw/master/MyPic/DB/Hash%20Index.jpeg)

B+ 树

![B+Tree Index](https://github.com/liubobo1996/boboWeb/raw/master/MyPic/DB/B%2BTree%20Index.png)
##### 3. 类型
主键索引 (叶子节点存储数据)
![主键索引](https://github.com/liubobo1996/boboWeb/raw/master/MyPic/DB/Primary%20Index.png)

二级索引/辅助索引 (叶子节点存储主键)
![二级索引](https://github.com/liubobo1996/boboWeb/raw/master/MyPic/DB/Secondary%20Index.png)
```bash
# 聚簇索引
data 域存放数据
# 非聚簇索引
data 域存放数据地址/主键

# 覆盖索引
直接根据该索引, 就可以查到数据 # 获取第 7 章的标题, 只需要查看目录
# 非覆盖索引
需要回表, 即多找一次主键索引 # 获取第 7 章的内容, 需要先查看目录, 再查看第 7 章

# 联合索引
使用表中的多个字段创建索引

# 唯一索引
该列的数据不重复						
```
